import{l as t,s as a,r as s,k as e,m as o,p as l,o as i,c as r,w as n,e as c,a as u,b as d,q as f,u as p,t as g,j as h,x as v,g as w,h as L,F as _,v as y,y as D,i as m,d as b,S,f as M,z as k,A as x}from"./index-95803fb6.js";import{_ as I,a as F,b as C,u as G,z as A,R,f as j,G as z,c as T}from"./date-format.23814063.js";import{g as Y,b as B,c as P,P as q,_ as H,o as N,h as $,f as E,s as U}from"./uni-popup.f6ae92fa.js";const J=t("staff-buy-list",{state:()=>({activitiesInfo:{},categoryList:[],swiperListData:null,currentSwiperData:{goodsList:[],pageIndex:1,loadMoreState:"noMore"}}),actions:{async getActivitiesInfo(){this.activitiesInfo=await Y(),this.categoryList=await B(),await this.getGoodsList(0)},async getGoodsList(t,a){this.swiperListData instanceof Map||(this.swiperListData=new Map);const s=this.activitiesInfo.id,e=this.categoryList[t].cate_id;let o=1,l="loading",i=[];if(this.swiperListData.has(t)){const r=this.swiperListData.get(t);if(console.log(r),o=r.pageIndex,"noMore"===r.loadMoreState||a)i=r.goodsList,l=r.loadMoreState;else{const t=await P(s,e,o);r.goodsList.push(...t.data),i=r.goodsList,0===t.data.length||t.data.length<q?l="noMore":t.data.length===q&&(l="loading"),o++}}else{const t=await P(s,e,o);i.push(...t.data),0===t.data.length||t.data.length<q?l="noMore":t.data.length===q&&(l="loading"),o++}this.swiperListData.set(t,{goodsList:i,pageIndex:o,loadMoreState:l}),this.currentSwiperData=this.swiperListData.get(t)},destroy(){this.swiperListData instanceof Map&&(this.swiperListData.clear(),console.log(this.swiperListData.size))},getSwiperData(t){return this.swiperListData instanceof Map&&this.swiperListData.has(t)?(this.currentSwiperData=this.swiperListData.get(t),this.currentSwiperData):(this.currentSwiperData={goodsList:[],pageIndex:1,loadMoreState:"noMore"},this.currentSwiperData)}}}),K=H({__name:"staff-buy-page-swiper",setup(t){const Y=J(),{activitiesInfo:B,goodsList:P,currentSwiperData:q}=a(Y),H=s(),K=s(),O=s(),Q=s(),V=s(""),W=s(0),X=s(!1);let Z=0;const tt=()=>{y()},at=()=>{H.value.showPop()},st=()=>{U("我的订单")},et=()=>{U("购物车")},ot=e((()=>{var t;return null==(t=Y.categoryList)?void 0:t.map((t=>t.cate_name))}));o(B,(t=>{switch(B.value.status){case 1:V.value="距离本期特定折扣购买截止:",X.value=!0;break;case 2:V.value="本期特定折扣已截止，请耐心等待下期哦～",X.value=!1;break;case 3:V.value=`下期特定折扣购买于${j(B.value.next_start_at,"YYYY-MM-DD hh:mm")}开始`,X.value=!1}})),N((()=>{console.log("onLoad"),Y.getActivitiesInfo()})),$((()=>{console.log("onUnload"),Y.destroy()}));const lt=(t,a)=>{Z=t,W.value=t,Y.getGoodsList(t,!0)},it=t=>{console.log("onScrollToBottom"),Y.getGoodsList(Z,!1)},rt=s(!1),nt=t=>{const a=D().windowHeight;rt.value=t.detail.scrollTop+50>a,console.log("scroll",t.detail.scrollTop,a)};E((()=>{Y.getGoodsList(Z,!0).finally((()=>{l()}))}));const ct=s(0);function ut(t){console.log(t.detail.current),W.value=t.detail.current,lt(t.detail.current)}return(t,a)=>{const s=m,e=b,o=c,l=x,y=S,D=M,j=k;return i(),r(o,{class:"staff-buy-container"},{default:n((()=>{var t;return[u(o,{class:"toolbar"},{default:n((()=>[u(s,{class:"back-btn",src:I,mode:"aspectFit",onClick:tt}),u(o,{class:"right"},{default:n((()=>[u(s,{class:"search",src:F}),u(e,null,{default:n((()=>[d("搜索")])),_:1})])),_:1})])),_:1}),u(j,{ref_key:"scrollRef",ref:Q,class:"scroll-view",onScrolltolower:it,onScroll:nt,"scroll-y":""},{default:n((()=>[u(o,{class:"header-wrapper",ref_key:"headRef",ref:O},{default:n((()=>[u(s,{class:"rule",src:C,onClick:at}),u(o,{class:"countdown-wrapper"},{default:n((()=>{var t;return[u(e,{class:f(["text",{"end-status-text":1!==p(B).status}])},{default:n((()=>[d(g(V.value)+"  ",1)])),_:1},8,["class"]),X.value?(i(),r(G,{key:0,timestamp:null==(t=p(B))?void 0:t.end_at,"show-colon":!1,"splitor-color":"#7749BC","background-color":"#764ABC",color:"#FFFFFF"},null,8,["timestamp"])):h("v-if",!0)]})),_:1})])),_:1},512),u(o,{class:f(["tab-wrapper",{"tab-wrapper-fixed":rt.value}])},{default:n((()=>[u(A,{ref_key:"tabRef",ref:K,class:"tab",list:p(ot),current:W.value,"bg-color":"#fff","active-color":"#FE395F","inactive-color":"#212121","bar-width":"16px",onChange:lt},null,8,["list","current"])])),_:1},8,["class"]),u(y,{class:"goods-swiper",style:v([{height:ct.value+"px"}]),onChange:ut,current:W.value},{default:n((()=>[(i(!0),w(_,null,L(p(ot),((t,a)=>(i(),r(l,{key:a},{default:n((()=>{var t,a;return[u(z,{"goods-list":null==(t=p(q))?void 0:t.goodsList,ref_for:!0,ref:t=>{!function(t){var a;let s=(null==(a=null==t?void 0:t.$el.querySelectorAll(".item")[0])?void 0:a.offsetHeight)+8;if(isNaN(s)&&(s=250),s){let t=q.value.goodsList,a=Math.ceil(t.length/2);ct.value=a*s+120}}(t)}},null,8,["goods-list"]),u(T,{"icon-size":20,iconType:"circle",status:null==(a=p(q))?void 0:a.loadMoreState,"content-text":{contentnomore:"-- 没有更多了 --"}},null,8,["status"])]})),_:1})))),128))])),_:1},8,["style","current"]),u(o,{class:"shopping-cart",onClick:et},{default:n((()=>[u(D,{class:"btn"},{default:n((()=>[d("查看购物清单")])),_:1})])),_:1})])),_:1},512),u(o,{class:"my-order",onClick:st},{default:n((()=>[d("我的订单")])),_:1}),u(R,{ref_key:"rulePopRef",ref:H,rules:null==(t=p(B))?void 0:t.rules},null,8,["rules"])]})),_:1})}}},[["__scopeId","data-v-859cf8c8"]]);export{K as default};
